/**
 * Shared TypeScript types for the GameEval QA Pipeline
 * 
 * Environment bindings (Env interface) are auto-generated by wrangler types
 * See worker-configuration.d.ts for the full Env interface
 * 
 * Add custom application types here as needed for future stories
 */

import type { Phase, LogType } from './constants';

// Database result types (Story 1.2)

/**
 * TestRun represents a test execution in the database
 */
export interface TestRun {
  id: string;
  url: string;
  input_schema: string | null;
  status: string;
  overall_score: number | null;
  created_at: number;
  updated_at: number;
  completed_at: number | null;
}

/**
 * EvaluationScore represents a single metric score for a test run
 */
export interface EvaluationScore {
  id: number;
  test_run_id: string;
  metric_name: string;
  score: number;
  justification: string;
  created_at: number;
}

/**
 * TestEvent represents a logged event during test execution
 */
export interface TestEvent {
  id: number;
  test_run_id: string;
  phase: string;
  event_type: string;
  description: string;
  timestamp: number;
  metadata?: string; // Optional JSON string for AI request metadata (model, cost, tokens)
}

/**
 * Generic database result wrapper for error handling
 */
export type DbResult<T> = 
  | { success: true; data: T }
  | { success: false; error: string };

// R2 Storage types (Story 1.3)

/**
 * Metadata extracted from screenshot paths
 */
export interface ScreenshotMetadata {
  /** Test pipeline phase (phase1-phase4) */
  phase: Phase;
  /** Action description (e.g., 'click-play-button') */
  action: string;
  /** Screenshot timestamp (Unix epoch in milliseconds) */
  timestamp: number;
}

/**
 * Screenshot artifact stored in R2 with parsed metadata
 */
export type ScreenshotArtifact = {
  /** R2 object key (full path) */
  key: string;
  /** Artifact discriminator */
  type: 'screenshot';
  /** Public URL for accessing the artifact */
  url: string;
  /** Upload timestamp (Unix epoch in milliseconds) */
  uploaded_at: number;
  /** Parsed metadata extracted from the object key */
  metadata: ScreenshotMetadata;
};

/**
 * Log artifact stored in R2 with parsed metadata
 */
export type LogArtifact = {
  /** R2 object key (full path) */
  key: string;
  /** Artifact discriminator */
  type: 'log';
  /** Public URL for accessing the artifact */
  url: string;
  /** Upload timestamp (Unix epoch in milliseconds) */
  uploaded_at: number;
  /** Parsed metadata extracted from the object key */
  metadata: {
    logType: LogType;
  };
};

/**
 * Represents a test artifact stored in R2
 */
export type TestArtifact = ScreenshotArtifact | LogArtifact;

// AI Gateway types (Story 1.5)

/**
 * AI model preference for routing
 */
export type ModelPreference = 'primary' | 'fallback';

/**
 * Token usage information from AI requests
 */
export interface TokenUsage {
  input?: number;
  output?: number;
  total?: number;
}

/**
 * AI request metadata for observability
 */
export interface AIMetadata {
  model: string;
  provider: 'workers-ai' | 'openai' | 'anthropic';
  cached?: boolean;
  cost?: number;
  tokens?: TokenUsage;
  latency_ms?: number;
  test_run_id?: string;
  user_id?: string;
  [key: string]: unknown; // Allow additional custom metadata
}

/**
 * Standardized AI response from callAI() helper
 */
export interface AIResponse {
  text: string;
  model: string;
  provider: 'workers-ai' | 'openai' | 'anthropic';
  cost?: number;
  cached?: boolean;
  tokens?: TokenUsage;
  metadata?: AIMetadata;
}

